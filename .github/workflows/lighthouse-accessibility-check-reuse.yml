name: Lighthouse Reuse CI

on:
  workflow_dispatch:
env:
  urls: ""
jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: Install Lighthouse
        run: |
          npm install -g lighthouse

      - name: Fetch Product Data and Generate URLs
        run: |
          API_URL="https://market.axonivy.com/marketplace-service/api/product?type=all&language=en&size=20&isRESTClient=false"
          BASE_URL="https://market.axonivy.com"

          # Fetch API response
          RESPONSE=$(curl -s "$API_URL")

          URLs="$BASE_URL"  # Initialize URLs with the base URL
          # Loop through the product IDs and generate URLs
          echo "Generated URLs:" # Debugging line to mark start of URL list
          echo "$URLs"  # Prints the initial value of URLs (BASE_URL)

          echo "$RESPONSE" | jq -r '.["_embedded"]["products"][]["id"]' | while read id; do
            # Append the new URL to the URLs variable
            URLs="$URLs $BASE_URL/$id"
            echo "$URLs"  # Print the updated URLs in each loop iteration
          done

          # Save the URLs to the environment variable
          echo "urls=$URLs" >> $GITHUB_ENV
          echo "Final URLs: $URLs"  # Print the final value of URLs after the loop

      - name: Audit URLs using Lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ env.urls }}
          uploadArtifacts: true

